var r = {};
var socket;


$(document).ready(function() {

  //init sockets for rounds
  initSockets();
  //init obj
  Timer();


  $("#showround").click();

  $("#speech1AC-nav").click();

  $("#speech1AC").html('<h1><u><b>2AC T Alt Energy</b></u></h1><p></p><p></p><p><b>We meet—the incentive in the plan is directly tied to alterative energy—means no ground loss</b></p><p><b></b></p><p><b>Coutner-interp—Renewable means inexhaustible—includes wood </b></p><p><b>DOE 97</b> (Glossary by the Energy Information Administration which provides official energy statistics from the US Government, http://www.eia.doe.gov/oiaf/1605/archive/gg97rpt/glossary.html, AG)</p><p><u>Renewable energy: Energy obtained from sources that are essentially inexhaustible (unlike</u>, for example, the <u>fossil fuels</u>, of which there is a finite supply). <u>Renewable sources of energy include wood, waste, geothermal, wind, photovoltaic, and solar thermal energy. </u></p><p><u><b></b></u></p><p><b>Alt energy includes biofuels </b></p><p><b>Gevo 8</b> – leading group on advanced biofuels research (Industry Terminology, http://www.gevo.com/glossary.php, AG)</p><p></p><p>Alternative Energy <u>Alternative energy is any energy derived from sources other than nuclear power or</u> the burning of <u>fossil fuels. Examples of alternative energy include renewable biofuels like butanol, solar power and wind power</u>. Alternative Fuels <u>Alternative fuels can be defined as any fuels that are substantially nonpetroleum</u> and yield energy security and environmental benefits. </p><p><b></b></p><p><b>Prefer this—</b></p><p><b>Predictability—our definition has a scientific basis WHY something is renewable or not—it has to be naturally inexhaustible—prefer this over list definitions because those are arbitrary and politically biased</b></p><p><b>Aff flex—don’t punish creative cases, aff flex outweighs on a topic when states make it impossible to be aff</b></p><p><b>Ground—we guarantee stable neg ground to biomass—and generic links check their offense </b></p><p><b>Limits—the question of limits should be based in literature—there’s always an incentive for them to exclude one more case, but this contrives the literature</b></p><p><b>Education—we have a right to education over ALL possible renewable to find the best one</b></p><p><b></b></p><p><b></b></p><p><b>Counterplans make research inevitable—they’ll have to research the biomass coutnerplan or PIC anyways, it’s better on the aff for in-depth debate </b></p><p><b></b></p><p><b>Wood is naturally replenish able</b></p><p><b>Mount Wachusett Community College 7</b> (http://www.mwcc.edu/renewable/biomass.html, AG)</p><p></p><p><u>Wood Biomass Energy is: Renewable: Utilizing the principles of scientific forest management our forests can provide a continuous and sustainable yield of wood biomass.</u> Biomass systems also can utilize tree trimmings, industrial waste wood, and wood from demolition and construction wastes, materials that are currently burdening our landfills and waste systems.</p><p><b></b></p><p><b>Good is good enough—defaulting to the most limiting interpretation incentives a race to margins of the topic - which excludes education on energy incentives like an RPS. A well rounded topic education should trump fears of limitless topic—proves you default to reasonability </b></p><p><b></b></p><p><b>Potential abuse is not a voter—not quantifiable and inevitable because there is always a thing we could’ve done</b></p><p></p><h1><u><b>2AC T Alt Energy—Biomass meets</b></u></h1><p></p><p><b></b></p><p><b>Woody biomass def</b></p><p><b>Patton-Mallory 6 </b>– National Biomass and Bio-Energy Coordinator, United States Forest Service (Marcia, April 6, RENEWABLE AND ALTERNATIVE ENERGY, CQ Congressional Testimony, lexis, AG)</p><p><u></u></p><p><u>Woody biomass</u>, the focus of the Forest Service Biomass and Bioenergy efforts, <u>is woody materials removed from National Forest System lands as a byproduct of fuels reduction and restoration activities. Woody biomass includes tree stems limbs, tops, needles, leaves and other woody parts</u>. Currently most of this material is underutilized, commercial value is low, markets are small to non-existent and the infrastructure needed to process this material is insufficient or nonexistent in many parts of the country. Frequently materials from forest fuels treatments that are too small for the products stream are also included in available biomass estimates.</p><p></p><p><b>T renewable </b></p><p><b>Environmental Magazine 2k</b> (E 11.3, Burning Biomass, ebsco, AG)</p><p></p><p><u>Biomass energy is considered a renewable or sustainable energy because of its closed carbon cycle. Since trees use as much carbon dioxide during their growth as they add to the atmosphere when burned, there is no net gain in carbon dioxide</u>--the leading offender of the greenhouse gases.</p><p><b></b></p><p><b></b></p><p><b>Woody biomass is renewable</b></p><p><b>Beaumont Enterprise 6</b> (3/26, Texas entrepreneur sees energy fuel in wood waste; [Final Edition], pq, AG)</p><p><u></u></p><p><u>The wood waste is a renewable energy resource. Even without the hurricane damage, logging in East Texas forests generates about 2.8 million tons of &quot;woody biomass&quot; annually, said</u> Burl <u>Carraway, assistant director of the Forest Services sustainable forest department.</u> </p><p></p><p></p><p></p><p><u><b>2AC T ISPEC</b></u></p><p><u><b></b></u></p><p><b>No right to specific ground—they still have enough to compete </b></p><p><b></b></p><p><b>We don’t need offense—arbitrary voters regress to demanding eight minute plans </b></p><p><b></b></p><p><b>Neg ground—reading normal means to normal means triples links—literature checks unpredictable agents and arbitrary 2ac spikes </b></p><p><b></b></p><p><b>Education—excluding stale process counterplans encourages focus on alt energy—unique topic to learn about biomass </b></p><p><b></b></p><p><b>We meet—plan makes biomass eligible for tax incentives and loan investments </b></p><p><b>States News Service 8</b> – quotes Congressman Stupak, a member of the House Committee on Energy and Commerce, which has jurisdiction over the RFS (2-8, STUPAK SUPPORTS EXPANDING RENEWABLE FUEL DEFINITION FOR TIMBER, lexis, AG)</p><p>U.S. Congressman on Bart Stupak (D-Menominee) has joined with a bipartisan group of lawmakers in introducing legislation to expand the federal definition of renewable biomass as it relates to timber. H.R. 5236, the Renewable <u>Biofuels Facilitation Act, would remove a prohibition using woody biomass</u> from federal lands for the production of cellulosic ethanol or biodiesel <u>to meet the</u> new federal Renewable Fuels Standard (<u>RFS</u>). To exclude timber harvested from the national forests puts northern Michigan at a disadvantage as new jobs are created in the renewable energy sector, Stupak said. This legislation recognizes the important role one of northern Michigan most abundant resources can play in America energy future. In December 2007, Congress passed and President Bush signed the Energy Independence and Security Act of 2007. The new law significantly expands the previously established <u>RFS</u>. Instead of requiring 5.4 billion gallons of renewable fuel in 2008, the new law <u>requires 9 billion gallons</u>. It also requires 36 billion gallons in 2022, instead of an estimated 8.6 billion gallons under previous law. <u>To meet this new goal, the law creates tax and loan incentives for investment in technologies and facilities that produce biofuels. </u>In the past, federal incentives have focused on corn-based biofuels, but the new law creates incentives for advanced biofuels, those biofuels produced of renewable fuel from feedstocks other than corn. While the law does recognize trees and thinnings as a qualified renewable biomass source, it specifically prohibits trees and thinnings from federal lands, including federal forestlands.</p><p></p><p><b>CX checks—they can win it’s binding</b></p><p><u><b>2AC T ASPEC</b></u><u><b> </b></u></p><p><u><b></b></u></p><p><b>No ground loss and we solve—only Congress can amend legislation </b></p><p><b></b></p><p><b>No right to specific ground—they still have enough to compete </b></p><p><b></b></p><p><b>We don’t need offense—arbitrary voters regress to demanding eight minute plans </b></p><p><b></b></p><p><b>Neg ground—reading normal means to the resolutional agent triples links—literature checks unpredictable agents and arbitrary 2ac spikes</b></p><p><b></b></p><p><b>Education—excluding stale counterplans encourages topic-specific innovation and research skills </b></p><p><b></b></p><p><b>USFG is an agent</b></p><p><b>DiLorenzo 2</b> – economics professor, Loyola (Thomas, http://www.lewrockwell.com/dilorenzo/dilorenzo15.html, AG)</p><p>The <u>Constitution </u>always<u> speaks of “the </u>United States” in the plural, signifying that the individual states were united in forming the f<u>ederal government as their agent</u> while maintaining their sovereignty over it;</p><p></p><p><b>CX checks—they can win it’s binding</b></p><p><b></b></p><p><u><b>2AC T Substantial</b></u></p><p><u><b></b></u></p><p><b>No ground loss—we’ll defend substantial increase n woody biomass</b></p><p><b></b></p><p><b>We meet—the plan substantially expands incentives for alternative energy—their evidence talks about ________ increase in the ________ budget—not the federal one </b></p><p><b></b></p><p><b>Their violation is bad</b></p><p><b>Arbitrary—millions of definitions of substantial in the context of energy means that the affirmative could never be prepared to debate substance and would always hit T</b></p><p><b>Not grounded in the literature—no affirmatives advocate an increase of 60% of the overall budget—their evidence talks about the DOE budge</b></p><p><b>No case meets—Excludes negative incentives which are key to knowledge on this topic because negative incentives play a huge role in energy policy. Guarantees that the plan is always the resolution because any specification of incentive is a material qualification </b></p><p><b></b></p><p><b>Counter interp—substantially should be defined by experts in the field—we’ll defend this size</b></p><p><b>Devinsky TWO</b> (Paul, Sept ember 2, “Is Claim “Substantially” Definite?” http://goliath.ecnext.com/coms2/summary_0199-848498_ITM, AG)</p><p>Thus, the Federal Circuit instructed that &quot;<u><b>resolution</b></u> of any ambiguity arising from the claims and <u><b>specification may be aided by</b></u> extrinsic evidence of usage and <u><b>meaning of a term in</b></u> the <u><b>context</b></u> of the invention.&quot; The Federal Circuit remanded the case to the district court with instruction that &quot;[<u><b>t</b></u>]<u><b>he question is not whether</b></u> the word <u><b>substantially</b></u><u></u><u><b> has a fixed meaning</b></u> as applied to constant wall thickness, <u><b>but how the phrase would be understood</b></u> by persons experienced <u><b>in this field</b></u> of mechanics, upon reading the patent documents.&quot;</p><p><b></b></p><p><b>Prefer it </b></p><p><b>a) All the reasons their interp is bad are net benefits to our counter-interp </b></p><p><b>b) Solves their offense—defending a substantial increase gives them ground to their DAs </b></p><p><b>c) Topic education—learning about </b><u><b>intricate details</b></u><b> of </b><u><b>specific incentives</b></u><b> is critical to learning about affirmatives—under their interpretation we wouldn’t get these heart of the topic affirmatives</b></p><p><b></b></p><p><b> </b><b>Don’t vote on potential abuse and we are reasonably topical so ere aff on shady T arguments like this </b></p><p><b></b></p><p><b>No neg on presumption—subsection of resolution but pretend that it’s a good idea </b></p><p><b></b></p><p></p><p></p><h1><u><b>2AC Overview—Case Outweighs</b></u></h1><p></p><p><b>Case outweighs—</b></p><p><b>Magnitude—their impacts are unqualified rhetoric, we have the only extinction-level impact backed by science</b></p><p><b>Prioritize long term focus—focus on short term impacts traps is bad policy analysis because it externalizes long term enviro concerns in the name on one shot disads, that’s Downes</b></p><p><b>Prefer systemic—billions are dying due to water and food shortages as a result of deforestation—our impact is linear meaning we’ll always risk solving millions from deaths, that’s Roberts—their one-shot disads are a yes or no question</b></p><p></p><h1><u><b>2AC Overview—No War</b></u></h1><p></p><p></p><p><b>Extend no major war—</b></p><p><b>Structural factors—nuclear weapons and other tech means countries know they perceive war as not in self-interest, public attitudes push policymakers towards negotiation, and if aggression does occur it’ll be through economic competition not military, that’s Fettweis</b></p><p><b>No escalation—history proves there’s a huge time between the event and war that allows for negotiation by risk-anticipating powers—and even if nuclear war breaks out, US nuclear first-strikes ensures we’d win immediately, that’s Leiber</b></p><p><b>Default aff—it’s the neg’s burden to prove these factors DON’T matter—they can’t win even a percent risk because war either happens or not—their authors derive causation from correlation—they assert X is key, ignoring empirical observation and overlapping factors, that’s Leiber </b></p><p></p><h1><u><b>2AC Overview—No Disad Uniqueness</b></u></h1><p></p><p><b>No disad uniqueness—PTC has massive energy subsidies that’ll result in half a trillion investments and jobs, Congress is debating advanced biofuels this week, Obama will pass an XO allowing huge state-level emissions regulations, and he’ll spend over a hundred billion in green jobs and pass cap and trade next year, that’s the four 1AC cards all from this month</b></p><p><b></b></p><p></p><h1><u><b>2AC Overview—Predictions Fail</b></u></h1><p></p><p></p><p><b>Prefer systemic impacts—expert scenario predictions are as likely as random guesses</b></p><p><b>Menand 5</b> (Louis, 12/5, Everybodys an Expert, The New Yorker, http://www.newyorker.com/archive/2005/12/05/051205crbo_books1?printable=true, AG)</p><p></p><p>It is the somewhat gratifying lesson of Philip Tetlock’s new book, “Expert Political Judgment: How Good Is It? How Can We Know?” (Princeton; $35), that people who make prediction their business—people who appear as experts on television, get quoted in newspaper articles, advise governments and businesses, and participate in punditry roundtables—are no better than the rest of us. When they’re wrong, they’re rarely held accountable, and they rarely admit it, either. They insist that they were just off on timing, or blindsided by an improbable event, or almost right, or wrong for the right reasons. They have the same repertoire of self-justifications that everyone has, and are no more inclined than anyone else to revise their beliefs about the way the world works, or ought to work, just because they made a mistake. No one is paying you for your gratuitous opinions about other people, but the experts are being paid, and Tetlock claims that the better known and more frequently quoted they are, the less reliable their guesses about the future are likely to be. The accuracy of an expert’s predictions actually has an inverse relationship to his or her self-confidence, renown, and, beyond a certain point, depth of knowledge. People who follow current events by reading the papers and newsmagazines regularly can guess what is likely to happen about as accurately as the specialists whom the papers quote. Our system of expertise is completely inside out: it rewards bad judgments over good ones. “Expert Political Judgment” is not a work of media criticism. Tetlock is a psychologist—he teaches at Berkeley—and <u>his conclusions are based on a long-term study that </u>he began twenty years ago. He <u>picked two hundred</u> and eighty-four <u>people who made their living “commenting</u> or offering advice <u>on political and economic trends</u>,” and he started asking them to assess the probability that various things would or would not come to pass, both in the areas of the world in which they specialized and in areas about which they were not expert. Would there be a nonviolent end to apartheid in South Africa? Would Gorbachev be ousted in a coup? Would the United States go to war in the Persian Gulf? Would Canada disintegrate? (Many experts believed that it would, on the ground that Quebec would succeed in seceding.) And so on. By the end of the study, in 2003, the experts had made 82,361 forecasts. Tetlock also asked questions designed to determine how they reached their judgments, how they reacted when their predictions proved to be wrong, how they evaluated new information that did not support their views, and how they assessed the probability that rival theories and predictions were accurate. Tetlock got a statistical handle on his task by putting most of the forecasting questions into a “three possible futures” form. The respondents were asked to rate the probability of three alternative outcomes: the persistence of the status quo, more of something (political freedom, economic growth), or less of something (repression, recession). And he measured his experts on two dimensions: how good they were at guessing probabilities (did all the things they said had an x per cent chance of happening happen x per cent of the time?), and how accurate they were at predicting specific outcomes. The results were unimpressive. On the first scale, the <u>experts</u> performed worse than they would have if they had simply assigned an equal probability to all three outcomes—if they had given each possible future a thirty-three-per-cent chance of occurring. Human beings who spend their lives studying the state of the world, in other words, <u>are poorer forecasters than dart-throwing monkeys</u>, who would have distributed their picks evenly over the three choices. Tetlock also found that specialists are not significantly more reliable than non-specialists in guessing what is going to happen in the region they study. Knowing a little might make someone a more reliable forecaster, but Tetlock found that knowing a lot can actually make a person less reliable. “We reach the point of diminishing marginal predictive returns for knowledge disconcertingly quickly,” he reports. “In this age of academic hyperspecialization, there is no reason for supposing that contributors to top journals—distinguished political scientists, area study specialists, economists, and so on—are any better than journalists or attentive readers of the New York Times in ‘reading’ emerging situations.” And the more famous the forecaster the more overblown the forecasts. “Experts in demand,” Tetlock says, “were more overconfident than their colleagues who eked out existences far from the limelight.” People who are not experts in the psychology of expertise are likely (I predict) to find Tetlock’s results a surprise and a matter for concern. For psychologists, though, nothing could be less surprising. “Expert Political Judgment” is just one of more than a hundred studies that have pitted experts against statistical or actuarial formulas, and in almost all of those studies the people either do no better than the formulas or do worse. In one study, college counsellors were given information about a group of high-school students and asked to predict their freshman grades in college. The counsellors had access to test scores, grades, the results of personality and vocational tests, and personal statements from the students, whom they were also permitted to interview. Predictions that were produced by a formula using just test scores and grades were more accurate. There are also many studies showing that expertise and experience do not make someone a better reader of the evidence. In one, data from a test used to diagnose brain damage were given to a group of clinical psychologists and their secretaries. The psychologists’ diagnoses were no better than the secretaries’. The experts’ trouble in Tetlock’s study is exactly the trouble that all human beings have: we fall in love with our hunches, and we really, really hate to be wrong. Tetlock describes an experiment that he witnessed thirty years ago in a Yale classroom. A rat was put in a T-shaped maze. Food was placed in either the right or the left transept of the T in a random sequence such that, over the long run, the food was on the left sixty per cent of the time and on the right forty per cent. Neither the students nor (needless to say) the rat was told these frequencies. The students were asked to predict on which side of the T the food would appear each time. The rat eventually figured out that the food was on the left side more often than the right, and it therefore nearly always went to the left, scoring roughly sixty per cent—D, but a passing grade. The students looked for patterns of left-right placement, and ended up scoring only fifty-two per cent, an F. The rat, having no reputation to begin with, was not embarrassed about being wrong two out of every five tries. But Yale students, who do have reputations, searched for a hidden order in the sequence. They couldn’t deal with forty-per-cent error, so they ended up with almost fifty-per-cent error. The expert-prediction game is not much different. When television pundits make predictions, the more ingenious their forecasts the greater their cachet. An arresting new prediction means that the expert has discovered a set of interlocking causes that no one else has spotted, and that could lead to an outcome that the conventional wisdom is ignoring. On shows like “The McLaughlin Group,” these experts never lose their reputations, or their jobs, because long shots are their business. More serious commentators differ from the pundits only in the degree of showmanship. These serious experts—the think tankers and area-studies professors—are not entirely out to entertain, but they are a little out to entertain, and both their status as experts and their appeal as performers require them to predict futures that are not obvious to the viewer. The producer of the show does not want you and me to sit there listening to an expert and thinking, I could have said that. The expert also suffers from knowing too much: the more facts an expert has, the more information is available to be enlisted in support of his or her pet theories, and the more chains of causation he or she can find beguiling. This helps explain why specialists fail to outguess non-specialists. The odds tend to be with the obvious. Tetlock’s experts were also no different from the rest of us when it came to learning from their mistakes. Most people tend to dismiss new information that doesn’t fit with what they already believe. Tetlock found that his experts used a double standard: they were much tougher in assessing the validity of information that undercut their theory than they were in crediting information that supported it. The same deficiency leads liberals to read only The Nation and conservatives to read only National Review. We are not natural falsificationists: we would rather find more reasons for believing what we already believe than look for reasons that we might be wrong. In the terms of Karl Popper’s famous example, to verify our intuition that all swans are white we look for lots more white swans, when what we should really be looking for is one black swan. Also, people tend to see the future as indeterminate and the past as inevitable. If you look backward, the dots that lead up to Hitler or the fall of the Soviet Union or the attacks on September 11th all connect. <u>If you look forward, it’s just a random scatter of dots, many potential chains of causation leading to many possible outcomes</u>. We have no idea today how tomorrow’s invasion of a foreign land is going to go; after the invasion, we can actually persuade ourselves that we knew all along. The result seems inevitable, and therefore predictable. Tetlock found that, consistent with this asymmetry, <u>experts routinely misremembered the degree of probability they had assigned </u>to an event after it came to pass. They claimed to have predicted what happened with a higher degree of certainty than, according to the record, they really did. When this was pointed out to them, by Tetlock’s researchers, they sometimes became defensive. And, like most of us, experts violate a fundamental rule of probabilities by tending to find scenarios with more variables more likely. If a prediction needs two independent things to happen in order for it to be true, its probability is the product of the probability of each of the things it depends on. If there is a one-in-three chance of x and a one-in-four chance of y, the probability of both x and y occurring is one in twelve. But we often feel instinctively that if the two events “fit together” in some scenario the chance of both is greater, not less. The classic “Linda problem” is an analogous case. In this experiment, subjects are told, “Linda is thirty-one years old, single, outspoken, and very bright. She majored in philosophy. As a student, she was deeply concerned with issues of discrimination and social justice and also participated in antinuclear demonstrations.” They are then asked to rank the probability of several possible descriptions of Linda today. Two of them are “bank teller” and “bank teller and active in the feminist movement.” People rank the second description higher than the first, even though, logically, its likelihood is smaller, because it requires two things to be true—that Linda is a bank teller and that Linda is an active feminist—rather than one. <u>Plausible detail makes us believers.</u> When subjects were given a choice between an insurance policy that covered hospitalization for any reason and a policy that covered hospitalization for all accidents and diseases, they were willing to pay a higher premium for the second policy, because the added detail gave them a more vivid picture of the circumstances in which it might be needed. In 1982, an experiment was done with professional forecasters and planners. One group was asked to assess the probability of “a complete suspension of diplomatic relations between the U.S. and the Soviet Union, sometime in 1983,” and another group was asked to assess the probability of “a Russian invasion of Poland, and a complete suspension of diplomatic relations between the U.S. and the Soviet Union, sometime in 1983.” The <u>experts judged the second scenario more likely than the first, even though it required two separate events to occur. They were seduced by the detail. </u></p><p></p>')


  $("#speech1NC").html($("#speech1AC").html());
  $("#speech2AC").html('<h1><u><b>2ac afdsaf df');
  $("#speech2NC").html('<h1><u><b>2Nc ==============');


  //autofill usernames

  $("#judges, #aff1, #aff2, #neg1, #neg2").select2({
    ajax: {
      url: "/user/search",
      dataType: 'json',
      delay: 50,
      data: function (params) {
      return {userinfo: params.term};
      },
      processResults: function (data, params) {
        return {results: data.splice(0, u.name ? 5 : 0)}; //Login required to invite users
      },
      cache: true
      },
      minimumInputLength: 2,
      escapeMarkup: function (markup) { return markup; },

      maximumSelectionLength: 9,
      templateResult: function  (sel) {
        return sel.email ? u.name ? "<span><b>" +sel.text + "</b> " + sel.email + "</span>" : "Login required" : sel.text;
      }
      //data: finalList,

  })



    // FLOWING ****


    //  $(".speech ").attr('contenteditable', 'false')


    // allow only "flowing input" for enemy's speeches
    $("#round").on("mousedown click", ".flow-mode", function(e) {


    /*  if (r.aff1 == u.email || r.aff2 == u.email)
        r.mySide = "aff";
      else if (r.neg1 == u.email || r.neg2 == u.email)
        r.mySide = "neg";

      var isSpeechAff = $(this).index()%2;

      //if you're in your own speech or no side declared -- exit inserting flow
      if ( (!r.mySide) || (r.mySide == "aff" && isSpeechAff) || (r.mySide == "neg" && !isSpeechAff) )
        return;

        */





      console.log(e);


      var p = $(e.target).closest('p, .flow, .speech > *');

      if (p.prev().prev().hasClass("flow")){

        p.prev().prev().find('textarea').focus();

      }
      if (p.prev().hasClass("flow")){

        p.prev().find('textarea').focus();

      }
      else if (p.hasClass("flow")){

        p.find('textarea').focus();

      } else{

        var flow = $("<div class='flow'><textarea class='flow-text'></textarea> <div class='fa fa-2x fa-chevron-circle-down flow-toggle'></div> "+
          "  <div class='flow-link fa fa-2x fa-link'  data-placement='left' title='Click Flow Anchor, then select a response in another speech to scroll to, when you hover over this flow entry'></div></div>");

        flow.insertBefore(p)

        flow.find('textarea').focus();



        $('[title]').tooltip();
      }





        /*

      var range = document.createRange();
      range.setStart(el[0], 0);
      range.setEnd(el[0], 1);
      sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);*/


    })



    //allow user to create link to align scroll with paragraph in side-by-side speech
    $("#round").on("click", ".flow-link", function(){
      var _this = $(this);

      _this.toggleClass("active-link");


      if (_this.hasClass("active-link")){

          $(".active-speech").addClass('flow-link-selecting-mode');

          $(".active-speech > *").on("mousedown",  function() {

              $(".active-speech > *").off("mousedown");
              $(".active-speech").removeClass('flow-link-selecting-mode');


              var randomFlowId = Math.floor(Math.random()*1000);

              _this.data("flow-anchor",randomFlowId)

              $(this).addClass("flow-anchor-"+randomFlowId)


              //cant be same speech





          })



      }


    })

    $("#round").on("scroll", ".speech", function(){
      //$(this).scrollLeft(0);
    });


    //mouseover the flow entry to scroll lock-onto the linked response
    $("#round").on("mouseover mousemove", ".flow", function(){
      var _this = $(this).find(".flow-link");
      if (!_this.hasClass("active-link"))
        return;

      var anchor = $(".flow-anchor-" + _this.data("flow-anchor") );

      anchor.css('background-color', 'lightblue');
      setTimeout(function(){
        anchor.css('background-color', '');
      }, 1000)

      var target_speech = anchor.closest(".speech");

      //align the target's speech scroll to match
      target_speech.scrollTop(   target_speech.scrollTop()  - _this.offset().top   +  anchor.offset().top  )


    })



    $("#round").on("click", ".flow-toggle", function(){
      var _this = $(this);



      if (_this.hasClass("flow-collapsed")){ // show
        _this.removeClass("flow-collapsed fa-chevron-circle-right").addClass("fa-chevron-circle-down")
        _this = _this.parent();

          while (_this.next().length && !_this.next().hasClass("flow")){
              _this = _this.next();
              _this.show()
          }

      } else { //hide
        _this.addClass("flow-collapsed  fa-chevron-circle-right").removeClass("fa-chevron-circle-down")

        _this = _this.parent();

        while (_this.next().length && !_this.next().hasClass("flow")){

            _this = _this.next();
            _this.hide()
        }

      }
    })


  $('#round').on( 'change keyup cut paste', '.flow-text', function (){
      $(this).height("30px").height(this.scrollHeight);

      var text = $(this).val();

      //text = text.replace(/v /gi, 'VOTER')

      //$(this).text(text)


      console.log(text);

      if (!text.length)
        $(this).parent().remove()

  })

  $('#round').on( 'blur', '.flow-text', function (){

    var text = $(this).val();

    if (!text.length)
      $(this).parent().remove()

})




    $(".speech").on("scroll", function() {

      if ($(this).attr("contenteditable") == "false" || !$("li.active a").hasClass("btn btn-info"))
        return;

      console.log($(this).attr("contenteditable"));

      var scrollToPrior = $(this).attr("scroll") || 0;

      var y = $(this).offset().top + $(this).height() - 20;
      var x = $(this).offset().left + 50;

      var e = $(document.elementFromPoint(x, y));

      e = e.next() != null ? e.next() : e;

      console.log(e);

      var scrollTo = $(this).html().replace(/[\r\n]/gi, '')
        .indexOf(e.html().replace(/[\r\n]/gi, ''), scrollToPrior - 20);


      //var scrollTo = $(this).find("*")          .index( e );

      console.log(scrollTo);

      if (scrollTo < scrollToPrior)
        scrollTo = scrollToPrior;


      $(this).attr("scroll", scrollTo);


      $.get('round/updateScroll', {
        roundId: r._id,
        speechName: $(this).attr("id"),
        scrollTo: scrollTo
      });


    });


  //   ROUND CONTROL ******************


  $('.speech-nav').click(function(e) {

    var speechId = $(this).attr('id').replace("-nav","")

    $('.active-speech').removeClass('active-speech')
    $("#"+speechId).addClass('active-speech')


    $('.active-nav').removeClass('active-nav')
    $(this).addClass('active-nav')


    $('.speech:not(.active-speech)').hide();
    $('.active-speech').show();


    if ( $("#sidebyside").hasClass("active") && $(".active-nav").index() > 1){

      var prevSpeech =  $(".active-speech").prev(".speech");

      if ($(".active-speech").attr('id')=="speech1NR")
        prevSpeech = prevSpeech.prev();

      prevSpeech.show()


    }


  })


  $("#sidebyside").click(function() {
    $(this).toggleClass('active')
    $('.active-nav').click();
  })


  $("#roundcreate").click(function() {
    $("#aff1, #aff2, #neg1, #neg2, #judges").removeClass("btn-danger");


    if ($("#roundcreate").text() == "Invite") {


      $.getJSON('/round/create', {
        aff1: $("#aff1").val(),
        aff2: $("#aff2").val(),
        neg1: $("#neg1").val(),
        neg2: $("#neg2").val(),
        judges: $("#judges").val()

      }, function(r) {


        $("#aff1, #aff2, #neg1, #neg2, #judges").removeClass("btn-danger");

        for (var i in r)
          $("#" + r[i]).addClass("btn-danger");


      });


    } else {

      $.get('round/resend', {
        roundId: r._id
      });


    }

  });

  ///creae headings index
  $(".speech").on("input", function() {

    var index = $(this).find("#index").length ?
      $(this).find("#index") :
      $("<div>").attr("id", "index").css("margin-top", "-20px").css("position", "absolute").prependTo($(".speech.active"));


    var headings = $(this).find("h1");
    index.empty();
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      if (h.textContent.length > 2)
        index.append($("<a>")
          .attr("onClick", '$(this).parent().parent().find("h1")[' + i + '].scrollIntoView();')
          .html(h.textContent)
        ).append(" &bull; ");
    }
    index.contents().last().remove();


    $.post('round/update', {
      roundId: r._id,
      speech1AC: $("#speech1AC").html(),
      speech1NC: $("#speech1NC").html(),
      speech2AC: $("#speech2AC").html(),
      speech2NC: $("#speech2NC").html(),
      speech1NR: $("#speech1NR").html(),
      speech1AR: $("#speech1AR").html(),
      speech2NR: $("#speech2NR").html(),
      speech2AR: $("#speech2AR").html()
    });


  });


  //DRAG from editor into speech

  $('#docs').on('dragstart', function(e) {

    var range = window.getSelection().getRangeAt(0);
    var dragCopy = $("#drag-copy");
    dragCopy.hide();

    var selectionContents = range.cloneContents();
    dragCopy.empty();
    dragCopy.append(selectionContents);


    e.originalEvent.dataTransfer.effectAllowed = 'copy';


    $('#round .tab-pane').bind('dragover', false);

  });

  $('#docs').bind('dragend', function(e) {
    //alert(1)
    $("#drag-copy").empty();
  })


  $('.speech-nav').bind('dragover', false)
  .bind('drop', function(e) {

    if ($("#" + e.target.href.replace(/.+\#/gi, "")).attr('contenteditable') == 'false')
      return;

    if ($("#drag-copy").html().length == 0)
      return;

    e.preventDefault();
    e.stopPropagation();


    $("#" + e.target.href.replace(/.+\#/gi, "")).append($("#drag-copy").html());

      $("#drag-copy").empty();
  });


  $('.speech').bind('drop', function(e) {

    if ($(this).attr('contenteditable') == 'false')
      return;

      if ($("#drag-copy").html().length == 0)
        return;

    e.preventDefault();
    e.stopPropagation();

    $(e.target).append($("#drag-copy").html());

      $("#drag-copy").empty();


    $('#round .tab-pane').unbind('dragover');

    return false;

  })



  //TURN ON FLOW MODE for speech

    $("#speech-flow-mode").click(function(){

      $(".active-speech").toggleClass("flow-mode")

      $(".speech").attr("contenteditable","true");

      $(".flow-mode").attr("contenteditable","false");


      $(".active-nav i").remove()

      if ($(".active-nav").hasClass("scroll")){

        $(".active-nav").removeClass("scroll").prepend('<i class="fa fa-fw fa-pencil"></i>')

      } else {

        $(".active-nav").addClass("scroll").prepend('<i class="fa fa-fw fa-cloud-download"></i>')


      }


      $(".active-speech").scrollTop(
        $(".active-speech").scrollTop() + Math.floor($(".active-speech").height() * .99));

      $(".active-speech").trigger("scroll");


    })





  //FULLSREEN

  $('#fullscreen').click(function() {


      $('#round').css("max-width", "100%");
      $('#sidebar, #docs').hide();



  })

  //PUBLISH SCROll

  $('#speechscroll').click(function() {

    $(".active-nav i").remove()

    if ($(".active-nav").hasClass("scroll")){

      $(".active-nav").removeClass("scroll").prepend('<i class="fa fa-fw fa-eye-slash"></i>')

    } else {

      $(".active-nav").addClass("scroll").prepend('<i class="fa fa-fw fa-eye"></i>')


    }


    $(".active-speech").scrollTop(
      $(".active-speech").scrollTop() + Math.floor($(".active-speech").height() * .99));

    $(".active-speech").trigger("scroll");


  })






});


function round_init() {
  $.getJSON("/round", function(resp) {

    $("#pastrounds").empty();

    if (resp.length)
      $("#pastrounds").addClass("well")

    for (var i in resp) {

      var roundDiv = $("<div>");
      roundDiv.attr('id', resp[i]._id);

      roundDiv.html("<a class='label label-default'>" + (new Date(resp[i].date_created)).toLocaleDateString() + "</a> " +
        resp[i].aff1.name + " " + resp[i].aff2.name + " <strong>vs</strong> " +
        resp[i].neg1.name + " " + resp[i].neg2.name  + " <strong>judged by</strong> " +
        resp[i].judges.map(function(i) { return i.name; }).join(", ") );


      roundDiv.click(function() {

        r._id = $(this).attr('id');

        startRound();
      })

      $("#pastrounds").append(roundDiv);

    }


  });
}


function startRound() {

  if (!$("#round").is(":visible")) {

    $("#showround").click();
  }

  $.getJSON("/round/read", {
    id: r._id
  }, function(roundJSON) {
    //set global

    r = roundJSON;
    //#AACFE7

    $("#speech1AC").html(r.speech1AC.text);
    $("#speech1NC").html(r.speech1NC.text);
    $("#speech2AC").html(r.speech2AC.text);
    $("#speech2NC").html(r.speech2NC.text);

    $("#speech1NR").html(r.speech1NR.text);
    $("#speech1AR").html(r.speech1AR.text);
    $("#speech2NR").html(r.speech2NR.text);
    $("#speech2AR").html(r.speech2AR.text);

    /*$("#speech-tabs a").removeClass("btn-info");



    if (r.scroll_1AC) $("li a[href=#speech1AC]").addClass("btn btn-info");
    if (r.scroll_1NC) $("li a[href=#speech1NC]").addClass("btn btn-info");
    if (r.scroll_2AC) $("li a[href=#speech2AC]").addClass("btn btn-info");
    if (r.scroll_2NC) $("li a[href=#speech2NC]").addClass("btn btn-info");
    if (r.scroll_1NR) $("li a[href=#speech1NR]").addClass("btn btn-info");
    if (r.scroll_1AR) $("li a[href=#speech1AR]").addClass("btn btn-info");
    if (r.scroll_2NR) $("li a[href=#speech2NR]").addClass("btn btn-info");
    if (r.scroll_2AR) $("li a[href=#speech2AR]").addClass("btn btn-info");*/



    $('.username-select').empty()

    $("#aff1").append("<option value='"+r.aff1.id+"'selected>"+r.aff1.name+"</option>");
    $("#aff2").append("<option value='"+r.aff2.id+"'selected>"+r.aff2.name+"</option>");
    $("#neg1").append("<option value='"+r.neg1.id+"'selected>"+r.neg1.name+"</option>");
    $("#neg2").append("<option value='"+r.neg2.id+"'selected>"+r.neg2.name+"</option>");

    for (var i in r.judges)
      $('#judges').append("<option value='"+r.judges[i].id+"' selected>"+r.judges[i].name+"</option>");

    $('.username-select').trigger('change');

    for (var i in r.judges)
      if (r.judges[i].status)
        $("#judges+span .select2-selection__choice").eq(i).css("background-color", "rgb(170, 207, 231)")

    if (!r.judges.find(function(i){ return !i.status } ))
      $("#judges").removeClass("btn-info").attr("disabled", true);
    else
      $("#judges").addClass("btn-info");

    if (!r.aff1.status)
      $("#aff1").addClass("btn-info");
    else
      $("#aff1").removeClass("btn-info").attr("disabled", true);

    if (!r.aff2.status)
      $("#aff2").addClass("btn-info");
    else
      $("#aff2").removeClass("btn-info").attr("disabled", true);

    if (!r.neg1.status)
      $("#neg1").addClass("btn-info");
    else
      $("#neg1").removeClass("btn-info").attr("disabled", true);

    if (!r.neg2.status)
      $("#neg2").addClass("btn-info");
    else
      $("#neg2").removeClass("btn-info").attr("disabled", true);



    //block opp side input
    // $(".speech").attr("contenteditable", false);

    if (r.aff1.id == u.id || r.aff2.id == u.email.id)
      r.mySide = "aff";
    else if (r.neg1 == u.email || r.neg2 == u.email)
      r.mySide = "neg";

    $("#speech1AC, #speech2AC, #speech1AR, #speech2AR").addClass("aff");
    $("#speech1NC, #speech2NC, #speech1NR, #speech2NR").addClass("neg");


    $("#roundcreate").text("Resend");

    /*
    if (r.status_aff1 && r.status_aff2 && r.status_neg1 && r.status_neg2 && r.status_judges)
      $("#roundcreate").hide();
    else
      $("#roundcreate").show();
      */


  })


}








function initSockets(){

if (typeof(io)!="undefined")
   socket = io()

if (socket)
  socket.on('error', function() {

      console.log("end")
    location.reload(true);

  setTimeout(function() {
    location.reload(true);

  }, 100);
})
.on('connect', function() {

  $.get("/round/join", {
    socket: socket.id
  });



  socket.on('round_newTextForEnemy', function(r) {

    $("#" + r.speechName).html(r.speechPartial);

  });


  socket.on('round_newTextForPartner', function(round) {


    $("#speech1AC").html(round.speech1AC);
    $("#speech1NC").html(round.speech1NC);
    $("#speech2AC").html(round.speech2AC);
    $("#speech2NC").html(round.speech2NC);
    $("#speech1NR").html(round.speech1NR);
    $("#speech1AR").html(round.speech1AR);
    $("#speech2NR").html(round.speech2NR);
    $("#speech2AR").html(round.speech2AR);


  });

  socket.on('round_youAreInvited', roundInviteAlert);

  socket.on('round_inviteResponse', function onServerSentEvent(msg) {
    console.log(msg)
    startRound();


  });


})

window.roundInviteAlert = function(msg) {

  $("#info").append('<div class="alert alert-success alert-dismissable">' +
      '<button  class="close" data-dismiss="alert">&times;</button>' +
      'You have been invited into a round with ' + msg.people + '. <button data-dismiss="alert" class="btn btn-xs btn-primary">Accept</button></div>')
    .find(".btn-primary").click(function() {

      r = {
        _id: msg.roundId
      };

      $.get("/round/accept", {
        roundId: msg.roundId
      }, startRound);

    })

}


$(window).on('beforeunload', function() {
  if (socket)
    socket.close();
});

}
